{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "serviceName": {
        "type": "string"
      },
      "resourceEnvironmentName": {
        "type": "string",
        "metadata": {
          "description": "Short name of the environment. Used for the name of resources created"
        }
      },
      "aseResourceGroup": {
        "type": "string",
        "defaultValue": ""
      },
      "aseHostingEnvironmentName": {
        "type": "string",
        "defaultValue": ""
      },
      "appServicePlanSize": {
        "type": "string",
        "allowedValues": [
          "1",
          "2",
          "3"
        ],
        "defaultValue": "1"
      },
      "configurationStorageConnectionString": {
        "type": "securestring"
      },
      "nServiceBusConnectionString": {
        "type": "securestring"
      },
      "nServiceBusLicense": {
        "type": "securestring"
      },
      "configNames": {
        "type": "string",
        "defaultValue": "SFA.DAS.Reservations.Jobs,SFA.DAS.Encoding"
      },
      "environmentName": {
        "type": "string"
      },
      "version": {
        "type": "string",
        "defaultValue": "1.0"
      },
      "appServicePlanInstances": {
        "type": "int",
        "defaultValue": 2
      },
      "functionsExtensionVersion": {
        "type": "string",
        "defaultValue": "~4"
      },
      "resourceGroupLocation": {
        "type": "string"
      },
      "tags": {
        "type": "object"
      },
      "sharedEnvResourceGroup": {
        "type": "string"
      },
      "sharedApimResourceGroup": {
        "type": "string"
      },
      "sharedApimName": {
        "type": "string"
      },
      "sharedEnvVirtualNetworkName": {
        "type": "string"
      },
      "sharedServiceBusName": {
        "type": "string"
      },
      "subnetObject": {
        "type": "object"
      },
      "subnetServiceEndpointList": {
        "type": "array"
      },
      "subnetDelegations": {
        "type": "array"
      },
      "workerAccessRestrictions": {
        "type": "array"
      },
      "sharedSQLServerName": {
        "type": "string"
      },
      "utcValue": {
        "type": "string",
        "defaultValue": "[utcNow()]"
      },
      "minimumTlsVersion": {
        "type": "string",
        "defaultValue": "TLS1_2"
      },
      "SharedServiceBusFqdn": {
        "type": "string"
      }
    },
    "variables": {
      "deploymentUrlBase": "https://raw.githubusercontent.com/SkillsFundingAgency/das-platform-building-blocks/master/templates/",
      "resourcePrefix": "[concat('das-',toLower(parameters('resourceEnvironmentName')),'-' , parameters('serviceName'))]",
      "appServicePlanName": "[concat(variables('resourcePrefix'),'-asp')]",
      "functionAppNameForecasting": "[concat(variables('resourcePrefix'),'-fa')]",
      "functionAppNameForecastingCommitments": "[concat(variables('resourcePrefix'),'-comt-fa')]",
      "resourceGroupName": "[concat(variables('resourcePrefix'), '-rg')]",
      "storageAccountName": "[concat('das',toLower(parameters('resourceEnvironmentName')),parameters('serviceName'),'str')]"
    },
    "resources": [
      {
        "apiVersion": "2020-06-01",
        "name": "[variables('resourceGroupName')]",
        "type": "Microsoft.Resources/resourceGroups",
        "location": "[parameters('resourceGroupLocation')]",
        "tags": "[parameters('tags')]",
        "properties": {
        }
      },
      {
        "apiVersion": "2020-06-01",
        "name": "[concat('forecasting-jobs-function-app-subnet-', parameters('utcValue'))]",
        "resourceGroup": "[parameters('sharedEnvResourceGroup')]",
        "type": "Microsoft.Resources/deployments",
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "[concat(variables('deploymentUrlBase'),'subnet.json')]",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "virtualNetworkName": {
              "value": "[parameters('sharedEnvVirtualNetworkName')]"
            },
            "subnetName": {
              "value": "[parameters('subnetObject').name]"
            },
            "subnetAddressPrefix": {
              "value": "[parameters('subnetObject').addressSpace]"
            },
            "serviceEndpointList": {
              "value": "[parameters('subnetServiceEndpointList')]"
            },
            "delegations": {
              "value": "[parameters('subnetDelegations')]"
            }
          }
        }
      },
      {
        "apiVersion": "2021-04-01",
        "name": "[concat('forecasting-jobs-sql-firewall-rule-', parameters('utcValue'))]",
        "resourceGroup": "[parameters('sharedEnvResourceGroup')]",
        "type": "Microsoft.Resources/deployments",
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "[concat(variables('deploymentUrlBase'), 'sql-server-firewall-rules.json')]",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "serverName": {
              "value": "[parameters('sharedSQLServerName')]"
            },
            "subnetResourceIdList": {
              "value": "[createArray(reference(concat('forecasting-jobs-function-app-subnet-', parameters('utcValue'))).outputs.SubnetResourceId.value)]"
            }
          }
        }
      },
      {
        "apiVersion": "2020-06-01",
        "name": "[concat('function-app-insights-', parameters('utcValue'))]",
        "resourceGroup": "[variables('resourceGroupName')]",
        "type": "Microsoft.Resources/deployments",
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "[concat(variables('deploymentUrlBase'),'application-insights.json')]",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "appInsightsName": {
              "value": "[variables('functionAppNameForecasting')]"
            },
            "attachedService": {
              "value": "[variables('functionAppNameForecasting')]"
            }
          }
        }
      },
      {
        "apiVersion": "2020-06-01",
        "name": "[concat('commitments-function-app-insights-', parameters('utcValue'))]",
        "resourceGroup": "[variables('resourceGroupName')]",
        "type": "Microsoft.Resources/deployments",
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "[concat(variables('deploymentUrlBase'),'application-insights.json')]",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "appInsightsName": {
              "value": "[variables('functionAppNameForecastingCommitments')]"
            },
            "attachedService": {
              "value": "[variables('functionAppNameForecastingCommitments')]"
            }
          }
        }
      },
      {
        "apiVersion": "2020-06-01",
        "name": "[concat('storage-account-', parameters('utcValue'))]",
        "resourceGroup": "[variables('resourceGroupName')]",
        "type": "Microsoft.Resources/deployments",
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "[concat(variables('deploymentUrlBase'), 'storage-account-arm.json')]",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "storageAccountName": {
              "value": "[variables('storageAccountName')]"
            },
            "allowSharedKeyAccess": {
              "value": true
            },
            "minimumTlsVersion": {
              "value": "[parameters('minimumTlsVersion')]"
            }
          }
        }
      },   
      {
        "apiVersion": "2020-06-01",
        "name": "[concat('app-service-plan-', parameters('utcValue'))]",
        "resourceGroup": "[variables('resourceGroupName')]",
        "type": "Microsoft.Resources/deployments",
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "[concat(variables('deploymentUrlBase'),'app-service-plan.json')]",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "appServicePlanName": {
              "value": "[variables('appServicePlanName')]"
            },
            "aspSize": {
              "value": "[parameters('appServicePlanSize')]"
            },
            "aspInstances": {
              "value": "[parameters('appServicePlanInstances')]"
            },
            "nonASETier": {
              "value": "[parameters('appServicePlanTier')]"
            }
          }
        }
      },   
      {
        "apiVersion": "2020-06-01",
        "name": "[concat('function-app-', parameters('utcValue'))]",
        "resourceGroup": "[variables('resourceGroupName')]",
        "type": "Microsoft.Resources/deployments",
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "[concat(variables('deploymentUrlBase'),'function-app-v2.json')]",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "functionAppName": {
              "value": "[variables('functionAppNameForecasting')]"
            },
            "appServicePlanName": {
              "value": "[variables('appServicePlanName')]"
            },
            "appServicePlanResourceGroup": {
              "value": "[variables('resourceGroupName')]"
            },
            "subnetResourceId": {
              "value": "[reference(concat('forecasting-jobs-function-app-subnet-', parameters('utcValue'))).outputs.SubnetResourceId.value]"
            },
            "ipSecurityRestrictions": {
              "value": "[parameters('workerAccessRestrictions')]"
            },
            "functionAppAppSettings": {
              "value": {
                "array": [
                  {
                    "name": "AzureWebJobsStorage",
                    "value": "[reference(concat('storage-account-', parameters('utcValue'))).outputs.storageConnectionString.value]"
                  },
                  {
                    "name": "AzureWebJobsDashboard",
                    "value": "[reference(concat('storage-account-', parameters('utcValue'))).outputs.storageConnectionString.value]"
                  },
                  {
                    "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                    "value": "[reference(concat('function-app-insights-', parameters('utcValue'))).outputs.InstrumentationKey.value]"
                  },
                  {
                    "name": "FUNCTIONS_EXTENSION_VERSION",
                    "value": "~4"
                  },
                  {
                    "name": "NServiceBusConnectionString",
                    "value": "[parameters('nServiceBusConnectionString')]"
                  },
                  {
                    "name": "NServiceBusLicense",
                    "value": "[parameters('nServiceBusLicense')]"
                  },
                  {
                    "name": "FUNCTIONS_WORKER_RUNTIME",
                    "value": "dotnet"
                  },
                  {
                    "name": "Version",
                    "value": "1.0"
                  },
                  {
                   "name": "EnvironmentName",
                   "value": "[toUpper(parameters('environmentName'))]"
                  },
                  {
                  "name": "LoggingRedisConnectionString",
                  "value": "[parameters('loggingRedisConnectionString')]"
                  },
                  {
                  "name": "ConfigurationStorageConnectionString",
                  "value": "[parameters('configurationStorageConnectionString')]"
                  },
                  {
                  "name": "ConfigNames",
                  "value": "[parameters('configNames')]"
                  }
              ]
            }
          }
         }
        },
        "dependsOn": [
          "[concat('storage-account-', parameters('utcValue'))]",
          "[concat('app-service-plan-', parameters('utcValue'))]"
        ]
      },
      {
        "apiVersion": "2020-06-01",
        "name": "[concat('commitments-function-app-', parameters('utcValue'))]",
        "resourceGroup": "[variables('resourceGroupName')]",
        "type": "Microsoft.Resources/deployments",
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "[concat(variables('deploymentUrlBase'),'function-app-v2.json')]",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "functionAppName": {
              "value": "[variables('functionAppNameForecastingCommitments')]"
            },
            "appServicePlanName": {
              "value": "[variables('appServicePlanName')]"
            },
            "appServicePlanResourceGroup": {
              "value": "[variables('resourceGroupName')]"
            },
            "subnetResourceId": {
              "value": "[reference(concat('reservations-jobs-subnet-', parameters('utcValue'))).outputs.SubnetResourceId.value]"
            },
            "ipSecurityRestrictions": {
              "value": "[parameters('workerAccessRestrictions')]"
            },
            "functionAppAppSettings": {
              "value": {
                "array": [
                  {
                    "name": "ConfigurationStorageConnectionString",
                    "value": "[parameters('configurationStorageConnectionString')]"
                  },
                  {
                    "name": "NServiceBusConnectionString",
                    "value": "[parameters('nServiceBusConnectionString')]"
                  },
                  {
                    "name": "NServiceBusLicense",
                    "value": "[parameters('nServiceBusLicense')]"
                  },
                  {
                    "name": "ConfigNames",
                    "value": "[parameters('configNames')]"
                  },
                  {
                    "name": "EnvironmentName",
                    "value": "[parameters('environmentName')]"
                  },
                  {
                    "name": "Version",
                    "value": "[parameters('version')]"
                  },
                  {
                    "name": "AzureWebJobsStorage",
                    "value": "[reference(concat('storage-account-', parameters('utcValue'))).outputs.storageConnectionString.value]"
                  },
                  {
                    "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                    "value": "[reference(concat('function-app-insights-prv-', parameters('utcValue'))).outputs.ConnectionString.value]"
                  },
                  {
                    "name": "FUNCTIONS_EXTENSION_VERSION",
                    "value": "[parameters('functionsExtensionVersion')]"
                  },
                  {
                    "name": "FUNCTIONS_WORKER_RUNTIME",
                    "value": "dotnet-isolated"
                  },
                  {
                    "name": "AppName",
                    "value": "das-reservations-jobs-reservation-provider"
                  },
                  {
                    "name": "WEBSITE_RUN_FROM_PACKAGE",
                    "value": "1"
                  },
                  {
                    "name": "AzureWebJobsServiceBus__fullyQualifiedNamespace",
                    "value": "[parameters('SharedServiceBusFqdn')]"
                  }
                ]
              }
            }
          }
        },
        "dependsOn": [
          "[concat('app-service-plan-', parameters('utcValue'))]"
        ]
      },
      {
        "apiVersion": "2021-04-01",
        "name": "[concat('role-assignment-', variables('functionAppNameForecasting'), '-', parameters('utcValue'))]",
        "type": "Microsoft.Resources/deployments",
        "resourceGroup": "[parameters('sharedEnvResourceGroup')]",
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "[concat(variables('deploymentUrlBase'),'role-assignments/role-assignment-service-bus.json')]",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "principalId": {
              "value": "[reference(concat('function-app-', parameters('utcValue'))).outputs.managedServiceIdentityId.value]"
            },
            "assignmentType": {
              "value": "ServiceBusOwner"
            },
            "resourceName": {
              "value": "[parameters('sharedServiceBusName')]"
            }
          }
        }
      },
      {
        "apiVersion": "2021-04-01",
        "name": "[concat('role-assignment-', variables('functionAppNameForecastingCommitments'), '-', parameters('utcValue'))]",
        "type": "Microsoft.Resources/deployments",
        "resourceGroup": "[parameters('sharedEnvResourceGroup')]",
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "[concat(variables('deploymentUrlBase'),'role-assignments/role-assignment-service-bus.json')]",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "principalId": {
              "value": "[reference(concat('commitments-function-app-', parameters('utcValue'))).outputs.managedServiceIdentityId.value]"
            },
            "assignmentType": {
              "value": "ServiceBusOwner"
            },
            "resourceName": {
              "value": "[parameters('sharedServiceBusName')]"
            }
          }
        }
      }
    ],
    "outputs": {
      "functionAppNameForecasting": {
        "type": "string",
        "value": "[variables('functionAppNameForecasting')]"
      },
      "functionAppNameForecastingCommitments": {
        "type": "string",
        "value": "[variables('functionAppNameForecastingCommitments')]"
      },
      "ResourceGroupName": {
        "type": "string",
        "value": "[variables('resourceGroupName')]"
      }
    }
  }